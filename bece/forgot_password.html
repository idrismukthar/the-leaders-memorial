<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recover Password - TLMPS</title>

    <link rel="icon" type="image/x-icon" href="img/favicon/favicon.ico">
    <link rel="apple-touch-icon" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/site.webmanifest">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="bece_style.css">
    <style>
        .recovery-card {
            background: var(--lilac);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            width: 90%;
            max-width: 420px;
            text-align: center;
            border: 3px solid var(--lemon-green);
        }
        .success-box {
            display: none;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid var(--lemon-green);
            color: var(--deep-purple);
        }
    </style>
</head>
<body>

<div class="recovery-card">
    <div class="logo-container">
        <img src="tlmps_logo.png" alt="TLMPS Logo" style="width: 80px;">
    </div>
    <h2 style="color: var(--deep-purple);">Password Recovery</h2>
    <p style="font-size: 0.85rem; margin-bottom: 20px;">Verify your identity to retrieve your password.</p>

    <div class="input-group">
        <label>EXAM YEAR</label>
        <select id="recoverYear">
            <option value="bece23">July 2023</option>
            <option value="bece24">July 2024</option>
            <option value="bece" selected>July 2025</option>
        </select>
    </div>

    <div class="input-group">
        <label>CANDIDATE SURNAME</label>
        <input type="text" id="recoverSurname" placeholder="ENTER SURNAME" autocomplete="off">
    </div>

    <div class="input-group">
        <label>MIDDLE NAME</label>
        <input type="text" id="recoverMiddle" placeholder="ENTER MIDDLE NAME" autocomplete="off">
    </div>

    <button class="btn-login" onclick="runRecovery()">RECOVER PASSWORD</button>
    
    <div id="resultBox" class="success-box"></div>
    <p id="errorBox" style="color: red; display: none; font-size: 0.85rem; margin-top: 10px;"></p>

    <a href="bece_login.html" class="forgot-link" style="margin-top: 20px; display: block;">Back to Login</a>
</div>

<script>
    async function runRecovery() {
    const resultBox = document.getElementById('resultBox');
    const errorBox = document.getElementById('errorBox');
    
    // --- RATE LIMITING LOGIC START ---
    const now = new Date();
    const count = parseInt(localStorage.getItem('recovery_count') || '0');
    const resetDateStr = localStorage.getItem('recovery_reset_date');
    const resetDate = resetDateStr ? new Date(resetDateStr) : null;

    // Check if a week has passed since the first recovery
    if (resetDate && now > resetDate) {
        // One week is up! Reset the counter
        localStorage.setItem('recovery_count', '0');
        localStorage.removeItem('recovery_reset_date');
    } else if (count >= 2) {
        // User has hit the limit
        const daysLeft = resetDate ? Math.ceil((resetDate - now) / (1000 * 60 * 60 * 24)) : 7;
        errorBox.style.display = "block";
        errorBox.textContent = `Security Limit Reached: You can only recover your password twice a week. Please try again in ${daysLeft} days or contact the school principal.`;
        resultBox.style.display = "none";
        return;
    }
    // --- RATE LIMITING LOGIC END ---

    const yearFile = document.getElementById('recoverYear').value + ".json";
    const surname = document.getElementById('recoverSurname').value.trim().toUpperCase();
    const middle = document.getElementById('recoverMiddle').value.trim().toUpperCase();

    if (!surname || !middle) {
        alert("Please fill in both name fields.");
        return;
    }

    try {
        const response = await fetch(yearFile);
        const data = await response.json();
        
        const student = data.find(s => 
            s.Candidate_SURNAME.trim().toUpperCase() === surname && 
            s.Candidate_MName.trim().toUpperCase() === middle
        );

        if (student) {
            // Update the counter on SUCCESSFUL recovery
            const newCount = count + 1;
            localStorage.setItem('recovery_count', newCount.toString());
            
            // If this is the first recovery, set the reset date for 7 days from now
            if (!resetDateStr) {
                const futureDate = new Date();
                futureDate.setDate(now.getDate() + 7);
                localStorage.setItem('recovery_reset_date', futureDate.toISOString());
            }

            errorBox.style.display = "none";
            resultBox.style.display = "block";
            resultBox.innerHTML = `
                <p style="margin:0; font-size: 0.9rem;">Identity Verified!</p>
                <h3 style="margin: 10px 0;">Password: <span style="color:red;">${student.password}</span></h3>
                <p style="font-size: 0.75rem;">Attempts used: ${newCount}/2 this week.</p>
            `;
        } else {
            resultBox.style.display = "none";
            errorBox.style.display = "block";
            errorBox.textContent = "No record matches this Surname and Middle Name.";
        }
    } catch (err) {
        alert("Error: Could not access the database.");
    }
    }
</script>

</body>
</html>